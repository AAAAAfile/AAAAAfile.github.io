<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>

    <title>表單</title>
    <style>
        input:invalid,
        select:invalid,
        textarea:invalid {
            box-shadow: 0 0 5px 1px red;
        }

        input:focus:invalid,
        select:focus:invalid,
        textarea:focus:invalid {
            outline: none;
        }

        .form-control:invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url(data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e);
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
    </style>
</head>

<body>
    <main class="container">
        <h1 class="text-center mt-3">表單</h1>

        <form action="https://script.google.com/macros/s/AKfycbySASay2eAZPCzsCaLC30bh_Uh8HJJ_IgLwEBGlVt8robrPsYRJvlar9_SxAv-gvJ83/exec" method="post">
            <div class="row">

        <!-- 水平線 -->
        <hr style='background-color:red; height: 5px; border:none;' />
        <br>

        <form action="https://script.google.com/macros/s/AKfycbySASay2eAZPCzsCaLC30bh_Uh8HJJ_IgLwEBGlVt8robrPsYRJvlar9_SxAv-gvJ83/exec" class="border border-primary">
            <div class="row" id="form_item">
            </div>
            <button type="submit" class="btn btn-primary w-100" id="submit">送出</button>
        </form>
    </main>

    <script>
        window.onload = function()
        {

            let submitBtn = document.getElementById('submit');
            submitBtn.onclick = function() {};

            let box = document.querySelector('.container');
            box.insertAdjacentHTML("afterend", "<div class='text-center mt-3'>container寬度：" + box.clientWidth + "px</div>" + "<div class='text-center mt-3'>網頁可見區域寬：" + document.body.clientWidth + "px</div>");

            // 結構資料
            let stru = [{
                    label: '姓名',
                    type: 'text',
                    name: 'Name',
                    value: '',
                    valid: '', //required 必填
                    option: '',
                    width: '3'
                },
                {
                    label: '網址',
                    type: 'url',
                    name: 'Url',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: 'EMAIL',
                    type: 'email',
                    name: 'email',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: 'Password',
                    type: 'password',
                    name: 'password',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '日期方塊',
                    type: 'date',
                    name: 'date',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '年月方塊',
                    type: 'month',
                    name: 'month',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '年週方塊',
                    type: 'week',
                    name: 'week',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '顏色選擇器',
                    type: 'color',
                    name: 'color',
                    value: 'black',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '數字方塊',
                    type: 'number',
                    name: 'number',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '搜尋方塊',
                    type: 'search',
                    name: 'search',
                    value: '',
                    valid: '', //required
                    option: '',
                    width: '3'
                },
                {
                    label: '飲料',
                    type: 'radio',
                    name: 'radio',
                    value: '',
                    valid: '', //required
                    // option: ['單選1','單選2','單選3'],
                    option: '鳳梨|西瓜|酪梨',
                    width: '6'
                },
                {
                    label: '下拉選單',
                    type: 'select',
                    name: 'select',
                    value: '',
                    valid: '', //required
                    option: ' |下拉選單1|下拉選單2|下拉選單3',
                    width: '3'
                },
                {
                    label: '下拉複選',
                    type: 'select_m',
                    name: 'select_m',
                    value: '',
                    valid: '', //required
                    option: '下拉選單1|下拉選單2|下拉選單3',
                    width: '3'
                },
                {
                    label: '文字區域',
                    type: 'textarea',
                    name: 'textarea',
                    value: '請輸入文字',
                    valid: 'required', //required
                    width: '3',
                    row: '5'
                },
                {
                    label:'確認訂單',
                    type: 'checkbox',
                    name: 'checkbox',
                    value: '',
                    valid: '',
                    option: '選單1|選單2',
                    width: '3'
                },
                {
                    label:'callback_url',
                    type: 'hidden',
                    name: 'callback_url',
                    value: '',
                    valid: '',
                    option: '',
                    width: '12'
                },

            ];

            let form_item = document.getElementById('form_item');
            let form_item_html = options_html = '';
            let options;
            // 在迴圈宣告的變數只能在迴圈使用
            // 故在外宣告變數

            // 雙重音符號 模版字符串(template literals) ``
            // 如果我們想要連接字串，或是將算式的結果包含在裡面，用傳統的字串去寫會很瑣碎且麻煩。
            // 模版字符串能大量簡化這串程式碼:全部一串都只需要包含在一對重音符號裡，不再需要切開、合起一堆字串碎片。
            // 當你想要包含變數或者算式在字串裡時，你只需要放在佔位符 ${} 裡。

            for (let i in stru) {
                if (stru[i]['type'] === 'text' ||
                    stru[i]['type'] === 'url' ||
                    stru[i]['type'] === 'email' ||
                    stru[i]['type'] === 'password' ||
                    stru[i]['type'] === 'date' ||
                    stru[i]['type'] === 'month' ||
                    stru[i]['type'] === 'week' ||
                    stru[i]['type'] === 'number' ||
                    stru[i]['type'] === 'color' ||
                    stru[i]['type'] === 'search'
                ){
                    form_item_html += `
                    <div class="col-sm-${stru[i]['width']} mb-3">
                        <label for="${stru[i]['name']}" class="form-label">${stru[i]['label']}</label>
                        <input type="${stru[i]['type']}" name="${stru[i]['name']}" value="${stru[i]['value']}"
                        class="form-control" id="${stru[i]['name']}" ${stru[i]['valid']}>
                    </div>`;

                }
                else if (stru[i]['type'] === 'radio')
                {
                    // options = stru[i]['option'];
                    // 字串轉陣列
                    options = stru[i]['option'].split('|');
                    //options = ["鳳梨" ,"西瓜" ,"酪梨"]

                    //宣告一個變數去接stru[i]['option']的內容
                    options_html = ''

                    //跑迴圈
                    for (let num in options)
                    {
                        // 三元運算
                        // 當num==0時,required =stru[i]['valid']; 當 num!=0 required 為空
                        let required = (num == '0') ? stru[i]['valid'] : '';

                        options_html += `
                        <div class="form-check form-check-inline">
                            <input type="${stru[i]['type']}" name="${stru[i]['name']}"
                            value="${options[num]}" class="form-check-input"
                            id="${stru[i]['name']}_${num}" ${required}>
                            <label class="form-check-label" for="${stru[i]['name']}_${num}">${options[num]}</label>
                        </div>`;
                    };

                    form_item_html += `
                        <div class="col-sm-${stru[i]['width']} mb-3">
                            <label class="form-label w-100">${stru[i]['label']}</label>
                            ${options_html}
                        </div>`;
                }

                //下拉式選單單選
                else if (stru[i]['type'] === 'select') {
                    options = stru[i]['option'].split('|');
                    options_html = '';
                    for (let j in options) {
                        options_html += `
                            <option value="${options[j]}">${options[j]}</option>`
                    }

                    form_item_html += `
                        <div class="col-sm-${stru[i]['width']} mb-3">
                            <label class="form-label">${stru[i]['label']}</label>
                            <select name="${stru[i]['name']}" class="form-select"
                            id="${stru[i]['name']}">${options_html}</select>
                            </div>`
                }

                //下拉選單複選
                else if (stru[i]['type'] === 'select_m') {
                    options = stru[i]['option'].split('|');
                    options_html = '';

                    for (let m in options) {
                        options_html += `
                            <option value = "${options[m]}" >${options[m]}</option>`
                    };

                    form_item_html += `
                        <div class="col-sm-${stru[i]['width']} mb-3">
                            <label class="form-label">${stru[i]['label']}</label>
                            <select name="${stru[i]['name']}" class="form-select" id="${stru[i]['name']}" multiple>
                            ${options_html}
                            </select>
                        </div>`
                }

                //文字段落
                else if (stru[i]['type'] === 'textarea') {
                    form_item_html += `
                        <div class="col-sm-${stru[i]['width']} mb-3">
                            <label class="form-label">${stru[i]['label']}</label>
                            <textarea name="${stru[i]['name']}" class="form-control" id="${stru[i]['name']}" rows="${stru[i]['row']}" ${stru[i]['valid']}>${stru[i]['value']}</textarea>
                        </div>`
                }

                //checkbox單選
                else if (stru[i]['type'] === 'checkbox') {
                    options = stru[i]['option'].split('|');
                    options_html = '';
                    let required = stru[i]['valid'] ? `oninput="renderCheckbox('${stru[i]['name']}')"` : '';

                    for (let num in options) {
                        options_html += `
                        <div class = "form-check form-check-inline" >
                            <input type="${stru[i]['type']}" name="${stru[i]['name']}" value="${options[num]}" class="form-check-input" id="${stru[i]['name']}_${num}" ${stru[i]['valid']} ${required}>
                            <label class="form-check-label" for="${stru[i]['name']}_${num}">${options[num]}</label>
                        </div>`
                    };

                    form_item_html += `
                        <div class = "col-sm-${stru[i]['width']} mb-3" >
                            <label class = "form-label w-100" > ${stru[i]['label']}</label>
                            ${options_html}
                        </div>`

                }
                //隱藏
                else if(stru[i]['type'] === 'hidden')
                {
                    form_item_html += `
                    <input type="hidden" name="${stru[i]['name']}" value="${stru[i]['value']}" id="${stru[i]['name']}">
                    `
                }


            }

            form_item.innerHTML = form_item_html;

            let callback_url = document.getElementById('callback_url');
            callback_url.value = window.location.href;

        }

            // 渲染畫面
            function renderCheckbox(name)
            {
                if (isAtLeastOneChecked(name)){
                removeRequired(name);
                }else
                {
                    setRequired(name);
                }
                console.log('確認checkbox的狀態')
            }

            // 設定屬性 required
            function setRequired(name){
                let checkboxes = Array.from(document.getElementsByName(name));
                for (let i in checkboxes)
                {
                    checkboxes[i].setAttribute('required', true);
                }
                console.log('增加屬性')
            }


            // 移除屬性 required
            function removeRequired(name) {
                let checkboxes = Array.from(document.getElementsByName(name));
                for (let i in checkboxes) {
                    checkboxes[i].removeAttribute('required');
                }
                console.log('移除屬性')
            }

            // 判斷是否有勾選
            function isAtLeastOneChecked(name) {
                let checkboxes = Array.from(document.getElementsByName(name));
                return checkboxes.some(function(item) {
                return item.checked;
                });
                console.log('判斷是否有勾選')
            }

    </script>

</body>

</html>